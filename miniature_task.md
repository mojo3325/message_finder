# –ó–∞–¥–∞—á–∞: —É—Å—Ç–∞—Ä–µ–≤—à–∏–π CHAT_CONTEXT –≤ –ø—Ä–æ–º–ø—Ç–µ ‚Äî –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å–±–æ—Ä –∏ –∫—ç—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

## –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã (high-level)
–ú–æ–¥–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç **—É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Å—Ä–µ–∑ —á–∞—Ç–∞** –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞: –≤ `CHAT_CONTEXT` –ø–æ–ø–∞–¥–∞—é—Ç –Ω–µ –≤—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞; —ç—Ç–æ —Å–±–æ–π –≤ –º–µ—Ö–∞–Ω–∏–∫–µ **—Å–±–æ—Ä–∫–∏/–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è/–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏** –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–≤–æ–∑–º–æ–∂–Ω—ã –±–∞–≥–∏ –ø–∞–º—è—Ç–∏, –≥–æ–Ω–∫–∏, –Ω–µ–≤–µ—Ä–Ω—ã–µ –∫–ª—é—á–∏ –∫—ç—à–∞ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–∞—è –æ–ø–æ—Ä–∞ –Ω–∞ —Å—Ç–∞—Ä—ã–µ –±—É—Ñ–µ—Ä—ã).

## –°–∏–º–ø—Ç–æ–º–∞—Ç–∏–∫–∞ (—Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã)
### –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —á–∞—Ç
```
S:
üñº –®–æ —Ç—ã, –±—Ä–∞—Ç–∞–Ω –∫–∞–∫ —Ç–µ–±–µ —Ñ–æ—Ç–∫–∞?

S:
–í—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —è –ø–æ—Å–ª–µ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ üòÇ

S:
–ê—Ö–∞—Ö–∞—Ö–∞ –±–ª—è —ç—Ç–æ —Ç–æ—á–Ω–æ

S:
Voice Message

S:
üñº –ê —ç—Ç–æ –∫–∞–∫ ?
```

### –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–∞ –º–æ–¥–µ–ª—å
```
–§–∏–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
–í—Å–µ–≥–¥–∞ –∫—Ä–∞—Ç–∫–æ; –¥–µ—Ä–∂–∏ –æ–±—ä—ë–º –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö.
–í—Å–µ–≥–¥–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º; –Ω–µ —Å–ø–µ—à–∏, –Ω–µ —Ñ–∞–Ω—Ç–∞–∑–∏—Ä—É–π.

ROLES:
OWNER ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü –∞–∫–∫–∞—É–Ω—Ç–∞ (—è)
USER ‚Äî —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫/–¥—Ä—É–≥–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ —á–∞—Ç–∞
–ï—Å–ª–∏ –≥–æ–≤–æ—Ä—è—â–∏–π –Ω–µ —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ ‚Äî —Å—á–∏—Ç–∞–π —ç—Ç–æ USER

CHAT_CONTEXT (chronological):
USER @sutskevernord: –®–æ —Ç—ã, –±—Ä–∞—Ç–∞–Ω –∫–∞–∫ —Ç–µ–±–µ —Ñ–æ—Ç–∫–∞? [–§–æ—Ç–æ: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.jpg] (–û–ø–∏—Å–∞–Ω–∏–µ: –û–±–µ–∑—å—è–Ω–∞ –ø–ª—ã–≤–µ—Ç –ø–æ–¥ –≤–æ–¥–æ–π, –∑–∞–∫—Ä—ã–≤ –≥–ª–∞–∑–∞ –∏ —Ä–∞—Å–∫–∏–Ω—É–≤ —Ä—É–∫–∏. –ù–∞–¥ –Ω–µ–π –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è –ø—É–∑—ã—Ä—å–∫–∏ –≤–æ–∑–¥—É—Ö–∞.)
CURRENT_MESSAGE_FROM: USER
replier output:
–•–∞—Ö, –æ–±–µ–∑—å—è–Ω–∞ –≤ –∞—Ö—É–µ. –ü—Ä—è–º –∫–∞–∫ –º–æ–∏ –Ω–µ—Ä–≤—ã –ø–æ—Å–ª–µ —Å–ª–∏–≤–∞.
```
**–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:** –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–µ–∫—Å—Ç, voice, –≤—Ç–æ—Ä–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ). –ó–Ω–∞—á–∏—Ç, –ø—Ä–æ–º–ø—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏–∑ **—Å—Ç–∞—Ä–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–∞—Ç–∞**.

## –ì–∏–ø–æ—Ç–µ–∑—ã –ø—Ä–∏—á–∏–Ω
- –ù–µ–≤–µ—Ä–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è/–∫–ª—é—á –∫—ç—à–∞ (–Ω–∞–ø—Ä. –∫–ª—é—á –±–µ–∑ `last_message_id`/`message_count`).
- –°–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–ø–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π `preview_buffer`/–≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–µ–π—Ç –≤–º–µ—Å—Ç–æ –∂–∏–≤–æ–π –≤—ã–±–æ—Ä–∫–∏ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º `message.id`.
- –ì–æ–Ω–∫–∞: –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –¥–æ –ø—Ä–∏—Ö–æ–¥–∞/–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
- –ù–µ–≤–µ—Ä–Ω—ã–π ¬´—è–∫–æ—Ä—å¬ª –æ–∫–Ω–∞ (—Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ `last_id`).
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–∞/–æ–±—ä–µ–∫—Ç–∞ –ø—Ä–æ–º–ø—Ç–∞ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏/–∑–∞–ø—Ä–æ—Å–∞–º–∏.

## –¶–µ–ª—å
–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å `CHAT_CONTEXT` –∏–∑ **–ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å–æ–æ–±—â–µ–Ω–∏–π** (–ø–æ `message.id`/`date`, –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é), –±–µ–∑ –ø–æ–ø–∞–¥–∞–Ω–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –¢–∏–ø—ã –º–µ–¥–∏–∞ –≤—Ç–æ—Ä–∏—á–Ω—ã; –≥–ª–∞–≤–Ω–æ–µ ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∏ –ø–æ–ª–Ω–æ—Ç–∞.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ—à–µ–Ω–∏—é
1. **–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã:** –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º N —Å–æ–æ–±—â–µ–Ω–∏—è–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Telethon (–∏–ª–∏ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ–≥–æ DAO), –∞ –Ω–µ –∏–∑ –∫—ç—à–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
2. **–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞:** –∫—ç—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–ª—é—á—É–µ—Ç—Å—è –∫–∞–∫ `{telegram_user_id}__{chat_id}`. –õ—é–±–æ–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–µ–ø–æ–∫ (—Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏).
3. **–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è:** –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ –≤—Ä–µ–º–µ–Ω–∏/`message.id` –∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –æ–∫–Ω–æ N –≤ –ø—Ä–æ–º–ø—Ç–µ –∏ –≤ –ª–æ–≥–∞—Ö.
4. **–ò–∑–æ–ª—è—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:** –Ω–∏–∫–∞–∫–æ–≥–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ `preview_buffer`/mutable singletons –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —á–∞—Ç–æ–≤/–∑–∞–ø—Ä–æ—Å–æ–≤.
5. **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –º–æ–¥–µ–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å `user_id`, `chat_id`, —Å–ø–∏—Å–æ–∫ `message_ids`, –∏—Å—Ç–æ—á–Ω–∏–∫ (`fresh_fetch|cache_hit`), –∏ –ø—Ä–∏—á–∏–Ω—É –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ (`new_message|force`). WARN –ø—Ä–∏ –¥—ã—Ä–∫–∞—Ö/—Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
6. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–∫–Ω–∞:** N –∑–∞–¥–∞—ë—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥–æ–º (`WARP_CONTEXT_LIMIT` –¥–ª—è –º–æ–¥–µ–ª–∏, `WARP_MINIATURE_LAST` –¥–ª—è UI), –æ–¥–∏–Ω–∞–∫–æ–≤–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–±–æ—Ä–µ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ –¥–∞—ë—Ç –≤ `CHAT_CONTEXT` **–≤—Å–µ** 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–≤–∫–ª—é—á–∞—è voice –∏ –≤—Ç–æ—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É) –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.
- –õ–æ–≥–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ `message_ids` –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ –∏ –ø—Ä–æ–º–ø—Ç–∞.
- –ü–æ—Å–ª–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–µ–∂–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç **–Ω–µ** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–∫—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è).

## –ü–ª–∞–Ω —Ä–∞–±–æ—Ç (–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ)
1. **–ê—É–¥–∏—Ç** —Ç–µ–∫—É—â–µ–≥–æ –ø—É—Ç–∏ —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–º–ø—Ç–∞ (`tg/handlers/warp.py`, `services/replier.py`, –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫—ç—à–∏) –∏ –º–µ—Å—Ç, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `preview_buffer`/–≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–µ–π—Ç.
2. **–ü—Ä–∞–≤–∫–∞ —Å–±–æ—Ä—â–∏–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:** –∂—ë—Å—Ç–∫–∞—è –æ–ø–æ—Ä–∞ –Ω–∞ –∂–∏–≤—É—é –≤—ã–±–æ—Ä–∫—É –ø–æ `message.id/date`; —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–∫–Ω–∞ N.
3. **–ö—ç—à-–∫–ª—é—á–∏ –∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è:** —É–ª—É—á—à–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞ –ø—Ä–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.
4. **–õ–æ–≥–∏/–º–µ—Ç—Ä–∏–∫–∏:** –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ ¬´–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞¬ª; –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —á–∞—Ç–µ.
5. **–¢–µ—Å—Ç –∫–µ–π—Å—ã:** —Å—Ü–µ–Ω–∞—Ä–∏–π –∏–∑ –ø—Ä–∏–º–µ—Ä–∞, ¬´–±—É—Ä—Å—Ç¬ª –∏–∑ 5‚Äì10 —Å–æ–æ–±—â–µ–Ω–∏–π, –±—ã—Å—Ç—Ä–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–µ–¥–∏–∞+—Ç–µ–∫—Å—Ç, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —á–∞—Ç—ã.

## –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞
- –ö—ç—à `_warp_index_cache` –Ω–µ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
- –ö–ª—é—á `{telegram_user_id}__{chat_id}` –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —á–∞—Ç–µ

### 2. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –≥–æ–Ω–∫–∏
- `_collect_warp_dialog_state` –º–æ–∂–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ `message_ids` –≤ –∫—ç—à–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é —á–∞—Ç–∞

### 3. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `message_ids` –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
- –ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ù–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö (–∫—ç—à vs —Å–≤–µ–∂–∏–π fetch)

## –§–∞–π–ª—ã/–º–æ–¥—É–ª–∏
- `tg/handlers/warp.py` ‚Äî —Å–±–æ—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Ç–∫–∞–∑ –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –±—É—Ñ–µ—Ä–æ–≤.
- `services/replier.py` ‚Äî —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ `CHAT_CONTEXT` –∏–∑ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `message_ids`.
- `tg/ui.py` ‚Äî —Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è; –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –∫—ç—à –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞.
- –ö—ç—à-—Å–ª–æ–π (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–ª—é—á–∏ –∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è.

## –ò—Ç–æ–≥: –∫–∞–∫ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å (–æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
- –ù–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫ –º–æ–¥–µ–ª–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è **—Å–≤–µ–∂–∏–π** `CHAT_CONTEXT` –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ `message.id/date` (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é).
- –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç **–≤—Å–µ** –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∏, –≤–∫–ª—é—á–∞—è —Ç–µ–∫—Å—Ç –∏ —è—Ä–ª—ã–∫–∏ –º–µ–¥–∏–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `[–§–æ—Ç–æ]`, `[Voice Message]`).
- –ü—Ä–æ–º–ø—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –ø–æ –æ–¥–Ω–æ–º—É —à–∞–±–ª–æ–Ω—É (–Ω–∏–∂–µ). –ù–∏–∫–∞–∫–∏–µ —Å—Ç–∞—Ä—ã–µ –±—É—Ñ–µ—Ä—ã/–∫—ç—à–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç.
- –ï—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–µ–ø–æ–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**.
- –û—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ `CHAT_CONTEXT` –∏ `CURRENT_MESSAGE_FROM`, –∞ –Ω–µ –æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

## –ü–∞–π–ø–ª–∞–π–Ω –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ (high-level)
1. **Fetch**: –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ `chat_id` –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (Telethon) —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ `message.id`.
2. **Normalize**: –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ –≤—ã—á–∏—Å–ª–∏—Ç—å `role` (OWNER/USER), –∞–≤—Ç–æ—Ä–∞, —Ç–µ–∫—Å—Ç; –¥–ª—è –º–µ–¥–∏–∞ –¥–æ–±–∞–≤–∏—Ç—å –∫—Ä–∞—Ç–∫–∏–π —è—Ä–ª—ã–∫ (`[–§–æ—Ç–æ]`, `[Voice Message]`, `[–í–∏–¥–µ–æ]`).
3. **Dedup & Window**: —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ `message.id`, –ø—Ä–∏–º–µ–Ω–∏—Ç—å –æ–∫–Ω–æ N (–æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –¥–ª—è –ª–æ–≥–æ–≤ –∏ –º–æ–¥–µ–ª–∏).
4. **BuildContext**: —Å–æ–±—Ä–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É `structured_context[]` —Å –ø–æ–ª—è–º–∏ `role`, `identifier`, `text`, `media`.
5. **CallModel**: –ø–µ—Ä–µ–¥–∞—Ç—å `message_text` –∏ `context` –≤ `replier.generate_reply_sync()` –∏ –ø–æ–ª—É—á–∏—Ç—å `replier output`.
6. **Log**: –∑–∞–ø–∏—Å–∞—Ç—å `user_id`, `chat_id`, `message_ids`, `source=fresh_fetch|cache_hit`, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç—Ç–∞–ø–æ–≤.

## –§–æ—Ä–º–∞—Ç –ø—Ä–æ–º–ø—Ç–∞ (—Å—Ç—Ä–æ–≥–∏–π)
```
–§–∏–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

–í—Å–µ–≥–¥–∞ –∫—Ä–∞—Ç–∫–æ; –¥–µ—Ä–∂–∏ –æ–±—ä—ë–º –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö.
–í—Å–µ–≥–¥–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º; –Ω–µ —Å–ø–µ—à–∏, –Ω–µ —Ñ–∞–Ω—Ç–∞–∑–∏—Ä—É–π.

ROLES:
OWNER ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü –∞–∫–∫–∞—É–Ω—Ç–∞ (—è)
USER ‚Äî —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫/–¥—Ä—É–≥–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ —á–∞—Ç–∞
–ï—Å–ª–∏ –≥–æ–≤–æ—Ä—è—â–∏–π –Ω–µ —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ ‚Äî —Å—á–∏—Ç–∞–π —ç—Ç–æ USER

CHAT_CONTEXT (chronological):
<—Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ>
USER @username: <—Ç–µ–∫—Å—Ç –∏–ª–∏ —è—Ä–ª—ã–∫ –º–µ–¥–∏–∞>
OWNER @me: <—Ç–µ–∫—Å—Ç>
...

CURRENT_MESSAGE_FROM: <USER|OWNER>
```
–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —è—Ä–ª—ã–∫–∏ –º–µ–¥–∏–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã, –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –º–µ–¥–∏–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã –¥–ª—è –¥–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏.

### –ü—Ä–∏–º–µ—Ä –ø—Ä–∏—ë–º–∫–∏ (–¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞)
**–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —á–∞—Ç:**
```
S:
üñº –®–æ —Ç—ã, –±—Ä–∞—Ç–∞–Ω –∫–∞–∫ —Ç–µ–±–µ —Ñ–æ—Ç–∫–∞?

D:
–í—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —è –ø–æ—Å–ª–µ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ üòÇ

S:
–ê—Ö–∞—Ö–∞—Ö–∞ –±–ª—è —ç—Ç–æ —Ç–æ—á–Ω–æ

S:
Voice Message

S:
üñº –ê —ç—Ç–æ –∫–∞–∫ ?
```
**–û–∂–∏–¥–∞–µ–º—ã–π `CHAT_CONTEXT`:**
```
CHAT_CONTEXT (chronological):
USER @sutskevernord: –®–æ —Ç—ã, –±—Ä–∞—Ç–∞–Ω –∫–∞–∫ —Ç–µ–±–µ —Ñ–æ—Ç–∫–∞? [–§–æ—Ç–æ]
OWNER @me: –í—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —è –ø–æ—Å–ª–µ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ üòÇ
USER @sutskevernord: –ê—Ö–∞—Ö–∞—Ö–∞ –±–ª—è —ç—Ç–æ —Ç–æ—á–Ω–æ
USER @sutskevernord: [Voice Message]
USER @sutskevernord: –ê —ç—Ç–æ –∫–∞–∫ ? [–§–æ—Ç–æ]
CURRENT_MESSAGE_FROM: USER
```

# –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
client.iter_messages(entity=fetch_target, limit=max(1, limit_fetch)) -> AsyncIterator[Message]

# –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
structured_context: list[dict[str, Any]] = [
    {
        "role": "OWNER|USER",
        "identifier": "@username|id:123",
        "text": "—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
        "media": [{"type": "photo", "context": "[–§–æ—Ç–æ]", ...}]
    }
]

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
generate_reply_sync(message_text: str, context: ReplyContext) -> str
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- `WARP_CONTEXT_LIMIT` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 40) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–æ–¥–µ–ª–∏.
- `WARP_MINIATURE_LAST` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 4) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã UI.
- –§–ª–∞–≥ `FORCE_FRESH_CONTEXT` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à —Ü–µ–ª–∏–∫–æ–º).

## –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
- –ï—Å–ª–∏ fetch –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–∞–¥–∞–µ—Ç, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å 1‚Äì2 —Ä–∞–∑–∞ —Å –¥–∂–∏—Ç—Ç–µ—Ä–æ–º.
- –ü—Ä–∏ –ø—É—Å—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ: –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å `WARN empty_context` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ –º–æ–¥–µ–ª—å –ø—Ä–æ–º–ø—Ç —Å –ø–æ–º–µ—Ç–∫–æ–π `CHAT_CONTEXT: <empty>`.
- –õ—é–±–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –æ–∫–Ω–∞ –∏–ª–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ‚Äî `WARN context_mismatch` —Å –¥–∞–º–ø–æ–º `message_ids`.

## –ú–µ—Ç—Ä–∏–∫–∏
- `context_fetch_duration_ms`, `context_message_ids_count`, `context_cache_hit`.
- `context_mismatch_total`, `context_invalidations_total`.
- –í–µ—Ä—Å–∏—è —à–∞–±–ª–æ–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞ `prompt_schema_version`.

## Definition of Done
- –ü—Ä–∏–º–µ—Ä –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ ¬´–ü—Ä–∏–º–µ—Ä –ø—Ä–∏—ë–º–∫–∏¬ª —Å—Ç–∞–±–∏–ª—å–Ω–æ –¥–∞—ë—Ç `CHAT_CONTEXT` –∏–∑ 5 —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ.
- –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è, —Å–æ—Å—Ç–∞–≤ `message_ids` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.
- –õ–æ–≥–∏ –¥–ª—è UI –∏ –¥–ª—è –º–æ–¥–µ–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å–ø–∏—Å–æ–∫ `message_ids`.
- –ü—Ä–æ–º–ø—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–¥–µ–ª—É ¬´–§–æ—Ä–º–∞—Ç –ø—Ä–æ–º–ø—Ç–∞ (—Å—Ç—Ä–æ–≥–∏–π)¬ª.
