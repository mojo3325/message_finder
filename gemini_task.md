

# Цели и поведение

* Приоритетная модель: **gemma-3-27b-it**.
* Провайдер-цепочка: **Gemini → Cerebras → Local**.
* Переключения только по лимитам/ошибкам, без героизма.
* Контракт ответа: строгий JSON для классификации, без сюрпризов.

# Лимиты для Gemini (Gemma 3 & 3n)

* **RPM**: 30
* **TPM**: 15 000
* **RPD**: 14 400
  Внедрить как параметры конфигурации и в политику рейтлимита. Если до потолка остаётся меньше безопасного зазора, заранее шифтуем на Cerebras, а не ловим 429.

# Архитектура потока (уровень задачи)

1. **Диспетчер** принимает батч задач на классификацию и строит один общий промпт + список айтемов.
2. **Оценка стоимости**: считаем прогноз **prompt\_tokens** и **output\_tokens** на батч.
3. **Политика рейтлимита**:

   * трекаем скользящее окно по **RPM**, **TPM**, **RPD**;
   * если прогнозная отправка нарушит любой лимит Gemini, маршрут сразу в Cerebras;
   * иначе отправляем в Gemini.
4. **Исполнение и парсинг**:

   * Gemini с температурой 0, mime `application/json`, строгий формат;
   * если Gemini отвечает 2xx, парсим и возвращаем;
   * если 429/5xx/таймаут/достигнут дневной/минутный лимит или предикт превышения — **мгновенно** переключаем на Cerebras;
   * если Cerebras не доступен или даёт retryable ошибки/лимиты — переключаем на локалку;
   * локалка считается «последней линией обороны» и не ретраится.
5. **Наблюдаемость**: логируем провайдера, латентность, размер батча, итоговые метки, причину фоллбэка, но не текст входа целиком.

# Что убрать (всё, что связано с Мистралем)

* Конфиги и env-переменные Mistral.
* Инициализацию клиента, ретраи, бэкоффы, отдельные обработчики ошибок.
* Любые ветви/флаги «mistral\_\*», метрики и логи по нему.
* Любые «умные» повторы на Мистраль при отказах других провайдеров. Его больше нет, и он нам не снится.

# Конфигурация (высокоуровнево)

* `PROVIDER_ORDER=gemini,cerebras,local`
* `GEMINI_MODEL=gemma-3-27b-it`
* `GEMINI_RPM=30`
* `GEMINI_TPM=15000`
* `GEMINI_RPD=14400`
* Защёлка безопасности: `GEMINI_TPM_GUARD=0.9`, `GEMINI_RPM_GUARD=0.9`, `GEMINI_RPD_GUARD=0.95`
  Когда прогноз токенов/запросов пересекает guard-долю лимита, перекидываем батч на Cerebras.

# Политика ретраев и фоллбэков

* **Gemini**: до 2 попыток на сетевые/5xx, никаких повторов при 429/лимитах → сразу Cerebras.
* **Cerebras**: одна попытка, при 5xx/429 → локалка.
* **Local**: без ретраев, просто вернуть результат или флаг ошибки для мониторинга.
* Никаких циклических фоллбэков. Строго вниз по цепочке.

# Контракт и промпт (кратко)

* Температура 0, `response_mime_type=application/json`.
* Формат ответа:

  ```json
  {"items":[{"id":"<string>","label":"0"|"1"}]}
  ```
* При мусорном тексте парсер вытаскивает метки из JSON или первой валидной цифры строки.

# Рейтлимитинг и планирование

* Менеджер квот ведёт три счётчика для Gemini: `rpm`, `tpm`, `rpd` со скользящими окнами; обновляет после каждого успешного запроса и резервации.
* Перед вызовом резервируем квоту по предикту; при отказе освобождаем.
* Для батчинга держим размер чанка таким, чтобы `est_in + est_out` и `rpm` не пробивали лимиты с учётом guard.

# Мониторинг и алерты

* Метрики: `provider_used`, `fallback_reason`, `latency_ms`, `parse_error_rate`, `empty_label_rate`.
* Алерты:

  * превышение guard по TPM/RPM/RPD,
  * доля фоллбэков > 5% за 15 мин,
  * p95 латентность > целевого SLA,
  * parse\_error\_rate > 0.5%.

# Тест-план (минимальный, но достаточный)

1. **Функциональные**: корректный JSON, JSON-строка, текст с меткой, пустой ответ.
2. **Лимиты**: симулировать переполнение RPM/TPM/RPD → ожидать Cerebras.
3. **Отказы**: 429/5xx/таймаут Gemini → Cerebras; 429/5xx Cerebras → локалка.
4. **Нагрузочные**: батчи 1/4/16; проверка, что guard срабатывает до 429.

# Роллаут

* Канареечный флаг `ENABLE_GEMINI=true`.
* 10% трафика → 50% → 100% при стабильных метриках.
* Откат: `PROVIDER_ORDER=cerebras,local` без редеплоя логики.

# Чек-лист «перед мёрджем»

* [ ] Удалены все упоминания Mistral: конфиги, код, метрики.
* [ ] Включены лимиты Gemini: `RPM=30`, `TPM=15000`, `RPD=14400` и guard-проценты.
* [ ] Провайдер-цепочка ровно `gemini → cerebras → local`.
* [ ] Температура 0, строгий JSON, единый парсер.
* [ ] Метрики и алерты заведены.
* [ ] Пройдены тесты лимитов и фоллбэков.

